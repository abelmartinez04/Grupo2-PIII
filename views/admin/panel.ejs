<%- include("../partials/adminHeader") %>

<div class="container mt-5">
  <h1 class="text-center mb-4 fw-bold">üëë Panel del Administrador</h1>

  <!-- Bot√≥n para crear nuevo usuario -->
  <div class="d-flex justify-content-end mb-3">
    <button class="btn btn-success" onclick="crearUsuario()">
      ‚ûï Crear nuevo usuario
    </button>
  </div>

  <!-- Tabla de usuarios existentes -->
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white fw-bold">
      Usuarios existentes
    </div>
    <div class="card-body">
      <table class="table table-striped table-hover align-middle text-center">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Rol</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% users.forEach(user => { %>
            <tr>
              <td><%= user.id %></td>
              <td><%= user.nombre_completo %></td>
              <td><%= user.email %></td>
              <td><%= user.rol_nombre || "Sin rol" %></td>
              <td>
                <button class="btn btn-outline-warning btn-sm"
                  onclick="editarUsuario('<%= user.id %>', '<%= user.nombre_completo %>', '<%= user.email %>', '<%= user.rol_id %>')">
                  ‚úèÔ∏è Editar
                </button>
                <button class="btn btn-danger btn-sm" 
                  onclick="eliminarUsuario('<%= user.id %>')">Eliminar</button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  function eliminarUsuario(id) {
    alertify.confirm("Confirmar eliminaci√≥n", "¬øEst√°s seguro de que deseas eliminar este usuario?",
      function() {
        fetch(`/admin/eliminar/${id}`, { method: "DELETE" })
          .then(res => res.json())
          .then(data => {
            alertify.success(data.message);
            setTimeout(() => location.reload(), 1000);
          })
          .catch(err => alertify.error("Error al eliminar usuario"));
      },
      function() {
        alertify.error("Cancelado");
      }
    );
  }
  const roles = {
    1: "Administrador",
    2: "Gerente",
    3: "Empleado",
    4: "Cajero"
  };

  // üü¢ Crear usuario con Alertify
  function crearUsuario() {
    const formHtml = `
      <div class="mb-2">
        <label>Nombre completo:</label>
        <input id="new-nombre" type="text" class="form-control" placeholder="Ej: Juan P√©rez" required>
      </div>
      <div class="mb-2">
        <label>Correo:</label>
        <input id="new-email" type="email" class="form-control" placeholder="usuario@email.com" required>
      </div>
      <div class="mb-2">
        <label>Contrase√±a:</label>
        <input id="new-password" type="password" class="form-control" placeholder="********" required>
      </div>
      <div class="mb-2">
        <label>Rol:</label>
        <select id="new-rol" class="form-select">
          ${Object.entries(roles)
            .map(([value, text]) => `<option value="${value}">${text}</option>`)
            .join("")}
        </select>
      </div>
    `;

    alertify.confirm("Crear nuevo usuario", formHtml,
      function () {
        const nombre = document.getElementById("new-nombre").value.trim();
        const email = document.getElementById("new-email").value.trim();
        const password = document.getElementById("new-password").value.trim();
        const rol = document.getElementById("new-rol").value;

        if (!nombre || !email || !password) {
          alertify.error("Por favor, complete todos los campos");
          return;
        }

        fetch("/admin/crear", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            nombre_completo: nombre,
            email,
            contrase√±a: password,
            rol_id: rol
          })
        })
          .then(res => {
            if (res.ok) {
              alertify.success("‚úÖ Usuario creado correctamente");
              setTimeout(() => location.reload(), 1200);
            } else {
              alertify.error("‚ùå Error al crear usuario");
            }
          })
          .catch(() => alertify.error("Error de conexi√≥n"));
      },
      function () {
        alertify.message("Creaci√≥n cancelada");
      }
    ).set({ labels: { ok: "Guardar", cancel: "Cancelar" }, padding: true, movable: false });
  }

  // Editar usuario con Alertify
  function editarUsuario(id, nombre, email, rol_id) {
    const formHtml = `
      <div class="mb-2">
        <label>Nombre completo:</label>
        <input id="edit-nombre" type="text" class="form-control" value="${nombre}">
      </div>
      <div class="mb-2">
        <label>Correo:</label>
        <input id="edit-email" type="email" class="form-control" value="${email}">
      </div>
      <div class="mb-2">
        <label>Rol:</label>
        <select id="edit-rol" class="form-select">
          ${Object.entries(roles)
            .map(([value, text]) => `<option value="${value}" ${value == rol_id ? "selected" : ""}>${text}</option>`)
            .join("")}
        </select>
      </div>
    `;

    alertify.confirm("Editar Usuario", formHtml,
      function () {
        const nuevoNombre = document.getElementById("edit-nombre").value;
        const nuevoEmail = document.getElementById("edit-email").value;
        const nuevoRol = document.getElementById("edit-rol").value;

        fetch(`/admin/editar/${id}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            nombre_completo: nuevoNombre,
            email: nuevoEmail,
            rol_id: nuevoRol
          })
        })
          .then(res => {
            if (res.ok) {
              alertify.success("‚úÖ Usuario actualizado correctamente");
              setTimeout(() => location.reload(), 1200);
            } else {
              alertify.error("‚ùå Error al actualizar usuario");
            }
          })
          .catch(() => alertify.error("Error en la solicitud"));
      },
      function () {
        alertify.message("Edici√≥n cancelada");
      }
    ).set({ labels: { ok: "Guardar", cancel: "Cancelar" }, padding: true, movable: false });
  }
</script>

<%- include("../partials/adminFooter") %>
